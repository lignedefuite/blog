+++
date = '2025-07-01'
draft = false
title = 'SM4端到端加密通信系统架构设计'
+++

<!--more-->
## 1. 系统总体架构

```
┌─────────────────┐    密钥协商    ┌─────────────────┐
│   用户 A 端      │ ←──────────→  │   用户 B 端      │
│                 │               │                 │
│ ┌─────────────┐ │               │ ┌─────────────┐ │
│ │ SM2密钥生成  │ │               │ │ SM2密钥生成   │ │
│ └─────────────┘ │               │ └─────────────┘ │
│ ┌─────────────┐ │               │ ┌─────────────┐ │
│ │ SM4加密引擎  │ │               │ │ SM4解密引擎  │ │
│ └─────────────┘ │               │ └─────────────┘ │
│ ┌─────────────┐ │               │ ┌─────────────┐ │
│ │ 信息隐藏模块. │ │               │ │ 信息提取模块. │ │
│ └─────────────┘ │               │ └─────────────┘ │
└─────────────────┘               └─────────────────┘
         │                                │
         └────────── 加密消息传输 ──────────┘
                   （WebSocket/文件）
```

## 2. 核心模块详细设计

### 2.1 加密引擎模块 (Crypto Engine)

**功能职责：**
- SM4对称加密/解密（支持ECB、CBC、CTR、GCM模式）
- SM3哈希算法
- SM2非对称加密/数字签名
- 密钥生成与管理

**接口设计：**
```python
class SM4CryptoEngine:
    def __init__(self, mode='GCM'):
        """初始化SM4加密引擎"""
        
    def encrypt(self, plaintext: bytes, key: bytes, iv: bytes = None) -> dict:
        """加密接口，返回密文和认证标签"""
        
    def decrypt(self, ciphertext: bytes, key: bytes, iv: bytes, tag: bytes = None) -> bytes:
        """解密接口，验证完整性后解密"""
        
    def generate_key(self) -> bytes:
        """生成128位SM4密钥"""
```

### 2.2 密钥协商模块 (Key Agreement)

**功能职责：**
- 基于SM2的椭圆曲线密钥协商
- ECDH密钥交换
- 临时密钥生成（一次一密）
- 前向保密性保证

**协商流程：**
1. 双方生成临时SM2密钥对
2. 交换公钥
3. 计算共享密钥
4. 派生会话密钥（使用SM3-KDF）
5. 验证密钥一致性

**接口设计：**
```python
class KeyAgreement:
    def generate_keypair(self) -> tuple:
        """生成SM2临时密钥对"""
        
    def compute_shared_key(self, private_key: bytes, peer_public_key: bytes) -> bytes:
        """计算共享密钥"""
        
    def derive_session_key(self, shared_key: bytes, info: bytes) -> bytes:
        """派生会话密钥"""
```

### 2.3 信息隐藏模块 (Steganography)

**功能职责：**
- 将密文嵌入PNG图像LSB
- 支持音频文件隐写
- HTML注释隐写
- 载体完整性检查

**实现策略：**
- **图像隐写**：修改像素最低有效位
- **音频隐写**：频域或时域嵌入
- **文本隐写**：零宽字符或格式化标记

### 2.4 消息传输模块 (Transport)

**传输方式：**
- WebSocket实时通信
- 文件传输（本地/网络）
- HTTP POST/GET接口
- 消息队列中转

**协议设计：**
```json
{
    "version": "1.0",
    "type": "key_exchange|encrypted_message",
    "sender_id": "user_a",
    "receiver_id": "user_b",
    "timestamp": 1640995200,
    "payload": {
        "public_key": "...", // 密钥协商阶段
        "ciphertext": "...", // 加密消息
        "iv": "...",
        "tag": "..."
    }
}
```

## 3. 端到端加密流程

### 3.1 初始化阶段
1. 用户A和B分别生成长期身份密钥对（SM2）
2. 交换并验证身份公钥
3. 建立可信通道（可选：通过二维码等带外方式）

### 3.2 会话建立
```
A → B: 生成临时密钥对(privA_temp, pubA_temp)
A → B: 发送 {pubA_temp, 签名(pubA_temp)}
B → A: 生成临时密钥对(privB_temp, pubB_temp)  
B → A: 发送 {pubB_temp, 签名(pubB_temp)}
A, B: 计算共享密钥 = ECDH(privA_temp, pubB_temp)
A, B: 派生会话密钥 = SM3-KDF(共享密钥, context)
```

### 3.3 消息加密传输
```
A: 原始消息 → SM4-GCM加密 → (可选)信息隐藏 → 发送
B: 接收 → (可选)信息提取 → SM4-GCM解密 → 原始消息
```

### 3.4 密钥更新
- 每N条消息后自动重新协商
- 检测到异常时立即更新
- 定时更新（如每小时）

## 4. 安全特性

### 4.1 前向保密 (Forward Secrecy)
- 使用临时密钥对，通信结束后销毁
- 长期密钥泄露不影响历史会话安全

### 4.2 完美保密 (Perfect Secrecy)  
- 一次一密原则
- 每次会话使用独立的随机密钥

### 4.3 消息认证
- SM4-GCM模式提供认证加密
- 防止篡改和重放攻击

### 4.4 身份验证
- 基于SM2数字签名验证身份
- 支持证书链验证（可选）

## 5. 性能指标

### 5.1 加密性能
- SM4加密速度：>100MB/s
- 密钥协商时间：<100ms
- 端到端延迟：<50ms（本地网络）

### 5.2 安全等级
- 对称加密：128位安全强度
- 非对称加密：256位椭圆曲线
- 哈希算法：256位输出

### 5.3 存储开销
- 密钥存储：<1KB/会话
- 消息膨胀率：<5%（含认证标签）

## 6. 实现优先级

### Phase 1: 核心加密功能
- [x] SM4加密引擎基础实现
- [ ] SM2密钥协商模块
- [ ] 基本的CLI测试工具

### Phase 2: 通信集成
- [ ] WebSocket传输层
- [ ] 消息协议定义
- [ ] 错误处理机制

### Phase 3: 高级特性
- [ ] 信息隐藏模块
- [ ] 性能优化
- [ ] 图形界面

### Phase 4: 完善与测试
- [ ] 安全性测试
- [ ] 性能基准测试
- [ ] 用户文档

## 7. 技术栈选择

### 后端实现
- **Python**: 快速原型，丰富的密码学库
- **Go**: 高性能，适合生产环境
- **C/C++**: 最高性能，底层优化

### 前端界面
- **CLI**: 命令行工具，便于调试
- **Web**: React/Vue + WebAssembly
- **Desktop**: Electron + Web技术

### 密码学库
- **gmssl**: Python国密算法库
- **libsm**: C语言国密实现
- **tongsuo**: 商汤开源密码库

## 8. 部署架构

```
┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│   Client A   │    │   Relay      │    │   Client B   │
│              │    │   Server     │    │              │
│ ┌──────────┐ │    │ (不解密消息)   │    │ ┌──────────┐ │
│ │加密引擎   │ │    │              │     │ │解密引擎   │ │
│ └──────────┘ │    │ ┌──────────┐ │    │ └──────────┘ │
│ ┌──────────┐ │←──→│ │消息转发   │ │←──→│ ┌──────────┐  │
│ │密钥协商   │ │    │ └──────────┘ │    │ │密钥协商    │ │
│ └──────────┘ │    │ ┌──────────┐ │    │ └──────────┘ │
└──────────────┘    │ │连接管理   │ │    └──────────────┘
                    │ └──────────┘ │
                    └──────────────┘
```

这个架构确保服务端只负责消息转发，无法解密用户通信内容，实现真正的端到端加密。